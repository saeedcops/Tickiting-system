load_module "/etc/nginx/modules/ngx_http_auth_ldap_module.so";

worker_processes  2;

events {
    worker_connections  1024;
}
  http {

    include       mime.types;
    default_type  application/octet-stream;

    client_body_timeout 12;
    client_header_timeout 12;
    keepalive_timeout 15;
    send_timeout 10;
    auth_ldap_cache_enabled on;
    auth_ldap_cache_expiration_time 10000;
    auth_ldap_cache_size 1000;
    # max_down_retries 50;

      ldap_server dc {
        url ldaps://192.168.175.200:3269/DC=Users,DC=cops,DC=com?sAMAccountName?sub?(objectClass=person);
        binddn "cops\\bind";
        binddn_passwd "P@ssw0rd";
        group_attribute uniquemember;
        group_attribute_is_dn on;
        require valid_user;
        satisfy any;
      }

      server {
        listen       8000;
        listen       443;
        server_name  192.168.175.128;
        access_log /var/log/nginx/theia.access.log;
        proxy_set_header Upgrade $http_upgrade;
        # proxy_set_header Connection $connection_upgrade;
        ssl_certificate /etc/nginx/ssl/certificate.crt;
        ssl_certificate_key /etc/nginx/ssl/private.key;
        ssl_password_file /etc/nginx/ssl/ssl_passwords;
        ssl_session_cache builtin:1000 shared:SSL:10m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
        ssl_prefer_server_ciphers on;

        auth_ldap "Forbidden";
        auth_ldap_servers dc;

        location / {
            root   html;
            index  index.html index.htm;
            proxy_pass http://192.168.175.128:8000;
            proxy_redirect http://192.168.175.128:8000 https://192.168.175.128:443;
        }

    }
  }



# load_module "/etc/nginx/modules/ngx_http_auth_ldap_module.so";

# worker_processes  1;

# events {
#     worker_connections  1024;
# }


# http {
#     include       mime.types;
#     default_type  application/octet-stream;

#     client_body_timeout 12;
#     client_header_timeout 12;
#     keepalive_timeout 15;
#     send_timeout 10;

#     auth_ldap_cache_enabled on;
#     auth_ldap_cache_expiration_time 10000;
#     auth_ldap_cache_size 1000;

#     ldap_server dc {
#         url ldap://192.168.175.200:3268/DC=Users,DC=cops,DC=com?sAMAccountName?sub?(objectClass=person);
#         binddn "Users\\bind";
#         binddn_passwd "P@ssw0rd";
#         group_attribute uniquemember;
#         group_attribute_is_dn on;
#         require valid_user;
#         satisfy any;
#       }

# # server {
# #      listen 80;
# #      server_name osg-support; # Replace it with your Subdomain
# #      return 301 https://$host$request_uri;
# # }

# map $http_upgrade $connection_upgrade {
#     default upgrade;
#     '' close;
# }

#  upstream osg-support {
#    # "django" is the web project as docker service.
#    server 192.168.175.128:8000;
#  }
# server {
#      listen       443;
#      server_name  localhost;
#      auth_ldap "Forbidden";
#      auth_ldap_servers dc;
#      access_log /var/log/nginx/theia.access.log;
#      proxy_set_header Upgrade $http_upgrade;
#      proxy_set_header Connection $connection_upgrade;
#      ssl_certificate /etc/nginx/ssl/certificate.crt;
#      ssl_certificate_key /etc/nginx/ssl/private.key;
#     #  listen on;
#      ssl_session_cache builtin:1000 shared:SSL:10m;
#      ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
#      ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;
#      ssl_prefer_server_ciphers on;

#   location / {
#          root   html;
#          index  index.html index.htm;
#          proxy_pass http://osg-support:8080;
#          proxy_redirect http://osg-support:8080 https://osg-support;
#          auth_ldap_servers dc;
#         }
# }
# }


# # user  nginx;
# # worker_processes  2;
 
# # error_log  /var/log/nginx/error.log warn;
# # pid        /var/run/nginx.pid;
 
# # events {
# #  # as mentioned on line 2 there will be 2 worker process
# #  # so in total 2*1024 = 2048 connections can be handled at a time
# #  worker_connections  1024;
# # }
 
# # http {
# #  # it includes support for all generic mime types.
# #     include mime.types;
# #     default_type application/octet-stream;

# #     client_body_timeout 12;
# #     client_header_timeout 12;
# #     keepalive_timeout 15;
# #     send_timeout 10;

# #     gzip on;

# #     # auth_ldap_cache_enabled on;
# #     # auth_ldap_cache_expiration_time 10000;
# #     # auth_ldap_cache_size 1000;

# #     # ldap_server dc {
# #     #     url ldap://192.168.175.200:3268/DC=cops,DC=com?sAMAccountName?sub?(objectClass=person);
# #     #     binddn "Users\\bind";
# #     #     binddn_passwd "P@ssw0rd";
# #     #     group_attribute uniquemember;
# #     #     group_attribute_is_dn on;
# #     #     require valid_user;
# #     #     }
# # }
# # #  include       /etc/nginx/mime.types;
# # #  # It mentioned default mime type
# # #  default_type  application/octet-stream;
 
# # #  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
# # #  '$status $body_bytes_sent "$http_referer" '
# # #  '"$http_user_agent" "$http_x_forwarded_for"';
 
# # #  access_log  /var/log/nginx/access.log  main;
 
# # #  sendfile        on;
 
# # #  upstream osg-support {
# # #    # "django" is the web project as docker service.
# # #    server django:8000;
# # #  }
 
# #  server {
# #   #  auth_ldap "AD authentication";
# #   #  auth_ldap_servers dc;
# #    # setting charset to utf-8
# #    charset     utf-8;
# #    # making nginx listen on port 8000
# #    listen      8000;
# #   #  listen 443 ssl;
# #   #  ssl_certificate /etc/nginx/ssl/certificate.crt;
# #   #  ssl_certificate_key /etc/nginx/ssl/private.key;
# #   #  ssl_password_file /etc/nginx/ssl/ssl_passwords;
# #    # servername is assigned here
# #    server_name localhost;
   
 
# #    # routing all request which includes url meda to /app/media/ so this traffic can be served by nginx
# #    location /static/ {
# #        alias /app/static/;
# #    }
 
# #    # routing all request which includes url meda to /app/media/ so this traffic can be served by nginx
# #    location /media/ {
# #        alias /app/media/;
# #    }
 
# #    location / {
# #      # checks for static file, if not found proxy to app
# #      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
# #      proxy_set_header Host $http_host;
# #     #  proxy_set_header X-Forwarded-Proto;
# #      proxy_redirect off;
# #      auth_ldap "Forbidden";
# #      auth_ldap_servers dc;
     
    
# #      # django_docker is upstream object as mentioned on line 23,
# #      # basically it is pointing to django docker service as mentioned in docker-compose.yml
# #      proxy_pass http://osg-support;


# #     # proxy_pass http://osg-support/;
# #     # proxy_set_header X-Real-IP  $remote_addr;
# #     # proxy_set_header X-Forwarded-For $remote_addr;
# #     # proxy_set_header Host $host;
# #     # proxy_set_header X-Forwarded-Proto $scheme;
# #     # proxy_redirect http://osg-support/ $scheme://$http_host/;
# #     # proxy_http_version 1.1;
# #     # proxy_set_header Upgrade $http_upgrade;
# #     # # proxy_set_header Connection $connection_upgrade;
# #     # proxy_read_timeout 20d;
# #     # proxy_buffering off;
 
# #    }
 
# # }
